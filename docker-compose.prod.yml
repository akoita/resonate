# Production-like stack for local Docker validation
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up --build
#
# This overrides the base docker-compose.yml to:
#   - Build and run the backend and frontend services
#   - Configure the Demucs worker for GCS storage (instead of shared volume)
#   - Set the backend to use GCS storage provider for original stem persistence

services:
  backend:
    build:
      context: ./backend
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://resonate:resonate@postgres:5432/resonate
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - ENABLE_CONTRACT_INDEXER=${ENABLE_CONTRACT_INDEXER:-false}
      - RPC_URL=${RPC_URL:-http://host.docker.internal:8545}
      - STEM_NFT_ADDRESS=${STEM_NFT_ADDRESS:-}
      - MARKETPLACE_ADDRESS=${MARKETPLACE_ADDRESS:-}
      - TRANSFER_VALIDATOR_ADDRESS=${TRANSFER_VALIDATOR_ADDRESS:-}
      - AA_ENTRY_POINT=${AA_ENTRY_POINT:-}
      - AA_FACTORY=${AA_FACTORY:-}
      - AA_CHAIN_ID=${AA_CHAIN_ID:-11155111}
      - AA_BUNDLER=${AA_BUNDLER:-}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
      - AGENT_RUNTIME=${AGENT_RUNTIME:-adk}
      - BLOCK_EXPLORER_URL=${BLOCK_EXPLORER_URL:-https://sepolia.etherscan.io}
      - DEMUCS_WORKER_URL=${DEMUCS_WORKER_URL:-http://demucs-worker:8000}
      - BACKEND_URL=${BACKEND_URL:-http://backend:3000}
      # GCS storage for stems (decoupled from worker — no shared volume)
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-gcs}
      - GCS_STEMS_BUCKET=${GCS_STEMS_BUCKET:-resonate-stems-dev}
      # Phase 2: Event-driven stem processing via Pub/Sub
      - STEM_PROCESSING_MODE=${STEM_PROCESSING_MODE:-pubsub}
      - PUBSUB_EMULATOR_HOST=${PUBSUB_EMULATOR_HOST:-pubsub-emulator:8085}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID:-resonate-local}
      # Admin / Maintenance
      - ADMIN_ADDRESSES=${ADMIN_ADDRESSES:-}
      - ENABLE_DEV_WIPE=${ENABLE_DEV_WIPE:-false}
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  # Demucs worker in GCS mode (no shared volume with backend)
  demucs-worker:
    environment:
      - STORAGE_MODE=gcs
      - GCS_BUCKET=${GCS_STEMS_BUCKET:-resonate-stems-dev}
      - OUTPUT_DIR=/outputs
      - PROCESSING_MODE=pubsub
      - GCP_PROJECT_ID=${GCP_PROJECT_ID:-resonate-local}
      - PUBSUB_SUBSCRIPTION=stem-separate-worker
      - PUBSUB_RESULTS_TOPIC=stem-results
    # Remove the shared bind mount from base config — GCS mode needs no local volumes
    volumes: !reset []

  web:
    build:
      context: ./web
    ports:
      - "3001:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:3000
    depends_on:
      - backend
    restart: unless-stopped
