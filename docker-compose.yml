services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: resonate
      POSTGRES_PASSWORD: resonate
      POSTGRES_DB: resonate
    ports:
      - "5432:5432"
    volumes:
      - resonate_pg:/var/lib/postgresql/data

  # Local AA Development Infrastructure
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil"]
    command:
      [
        "--host",
        "0.0.0.0",
        "--block-time",
        "1",
        "--chain-id",
        "31337",
        "--code-size-limit",
        "50000",
      ]
    ports:
      - "8545:8545"
    healthcheck:
      test:
        ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 3s
    profiles:
      - local-aa

  # Forked Sepolia AA Development Infrastructure
  # Requires SEPOLIA_RPC_URL env var (export or add to .env at project root)
  anvil-fork:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil"]
    command:
      [
        "--fork-url",
        "${SEPOLIA_RPC_URL}",
        "--chain-id",
        "11155111",
        "--host",
        "0.0.0.0",
        "--block-time",
        "1",
      ]
    ports:
      - "8545:8545"
    healthcheck:
      test:
        ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s
    profiles:
      - fork-aa

  # Alto bundler for forked Sepolia (ERC-4337 UserOp processing)
  alto-bundler-fork:
    image: ghcr.io/pimlicolabs/alto:latest
    command: >
      --entrypoints 0x0000000071727De22E5E9d8BAf0edAc6f37da032
      --rpc-url http://localhost:8545
      --executor-private-keys 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      --utility-private-key 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
      --port 4337
      --network-name sepolia
      --chain-id 11155111
      --unsafe
      --safe-mode false
      --balance-override false
    network_mode: host
    restart: on-failure
    profiles:
      - fork-aa

  alto-bundler:
    image: ghcr.io/pimlicolabs/alto:latest
    command: >
      --entrypoints 0x5FbDB2315678afecb367f032d93F642f64180aa3 --rpc-url http://anvil:8545 --executor-private-keys 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --utility-private-key 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d --port 4337 --network-name local --chain-id 31337 --unsafe
    ports:
      - "4337:4337"
    depends_on:
      anvil:
        condition: service_healthy
    restart: on-failure
    profiles:
      - local-aa

  # AI Stem Separation Worker (Demucs)
  # CPU mode by default. For GPU acceleration, use:
  #   docker compose -f docker-compose.yml -f docker-compose.gpu.yml up demucs-worker
  demucs-worker:
    build:
      context: ./workers/demucs
      args:
        CACHE_MODEL: "1" # Set to "0" to skip model pre-caching (faster builds, slower first run)
    ports:
      - "8000:8000"
    volumes:
      - ./backend/uploads/stems:/outputs
      - demucs_model_cache:/root/.cache/torch # Persist model cache between container rebuilds
    environment:
      - OUTPUT_DIR=/outputs
      - STORAGE_MODE=local
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: always
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
        ]
      interval: 30s
      timeout: 10s
      start_period: 120s # Model loading can take time on first start
      retries: 3

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: always

volumes:
  resonate_pg:
  demucs_model_cache: # Caches the ~1GB Demucs model between container rebuilds
