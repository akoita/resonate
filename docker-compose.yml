services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: resonate
      POSTGRES_PASSWORD: resonate
      POSTGRES_DB: resonate
    ports:
      - "5432:5432"
    volumes:
      - resonate_pg:/var/lib/postgresql/data

  # Local AA Development Infrastructure
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: [ "anvil" ]
    command: [ "--host", "0.0.0.0", "--block-time", "1", "--chain-id", "31337", "--code-size-limit", "50000" ]
    ports:
      - "8545:8545"
    healthcheck:
      test: [ "CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545" ]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 3s
    profiles:
      - local-aa

  alto-bundler:
    image: ghcr.io/pimlicolabs/alto:latest
    command: >
      --entrypoints 0x5FbDB2315678afecb367f032d93F642f64180aa3 --rpc-url http://anvil:8545 --executor-private-keys 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 --utility-private-key 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d --port 4337 --network-name local --chain-id 31337 --unsafe
    ports:
      - "4337:4337"
    depends_on:
      anvil:
        condition: service_healthy
    restart: on-failure
    profiles:
      - local-aa

volumes:
  resonate_pg:
